#include <stdio.h>
#include "portaudio.h"

const double SAMPLE_RATE = 44120;
const double FRAMES_PER_BUFFER = 256;

//anonymous struct 
struct stereo{
	float left;
	float right;
};


static int callback( const void *inputBuffer, void *outputBuffer,
		    unsigned long framesPerBuffer,
		    const PaStreamCallbackTimeInfo* timeInfo,
		    PaStreamCallbackFlags statusFlags,
		    void *userData )
{
	//cast void type pointers
	stereo* data = (stereo*) userData;
	(void) inputBuffer; //ignore inputBuffer
	float* out = (float*) outputBuffer;

	for(int i = 0; i < framesPerBuffer; ++i) {
		*out++ = data->left;
		*out++ = data->right;
		data->left = 1.02 * data->left + 0.005;
		data->right = 1.03 * data->right + 0.01;
		if(data->left > 1) {
			data->left = 0;
		}
		else if (data->right > 1) {
			data->right = 0;
		}
	}
	return 0; //return 1 to quit
}

void run(PaError err) {
	if(err != paNoError) {
		throw err;
	}
}

int main() {
	//start PortAudio
	try {
		run(Pa_Initialize());
		printf("Running %s", Pa_GetVersionText()); 
	}
	catch (PaError err) {
		printf("Pa_Initialize() error: %s", Pa_GetErrorText(err));
	}

	//main code
	try {
		PaStream* stream;
		stereo data = {0, 0};

		run(Pa_OpenDefaultStream(&stream, 0, 2, paFloat32, SAMPLE_RATE, FRAMES_PER_BUFFER, callback, &data));
		run(Pa_StartStream(stream));
		Pa_Sleep(4000);
		run(Pa_StopStream(stream));
		run(Pa_CloseStream(stream));
	}
	catch (PaError err) {
		printf("Main code error: %s", Pa_GetErrorText(err));
	}

	//end portAudio
	try {
		run(Pa_Terminate());
	}
	catch (PaError err) {
		printf("Pa_Initialize() error: %s", Pa_GetErrorText(err));
	}
}
